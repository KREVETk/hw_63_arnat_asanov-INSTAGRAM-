{% extends 'base.html' %}

{% block content %}
<div class="container mt-3">
  {% if request.GET.next %}
    <a href="{{ request.GET.next }}" class="btn btn-secondary mb-3">‚Üê –ù–∞–∑–∞–¥</a>
  {% endif %}
</div>

<div class="container mt-4" style="max-width: 800px;">
  <h1 class="mb-3">{{ post.description }}</h1>

  {% if post.image %}
    <div class="mb-4 text-center">
        <img src="{{ post.image.url }}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—Å—Ç–∞" class="img-fluid rounded" style="width: 100%; height: auto; max-width: 800px;">
    </div>
  {% endif %}

  <p class="text-muted">
    –ê–≤—Ç–æ—Ä: <strong>{{ post.author.username }}</strong> |
    –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: {{ post.created_at|date:"d.m.Y H:i" }} |
    –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤: {{ comments.paginator.count }}
  </p>

  <div class="mb-3 d-flex align-items-center gap-3">
    <form action="{% url 'board:post_like_toggle' post.pk %}" method="post" style="display:inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-link p-0" style="font-size: 1.5rem; color: {% if user in post.likes.all %}red{% else %}gray{% endif %}; border: none; background: none;">
        {% if user in post.likes.all %}
          ‚ù§Ô∏è
        {% else %}
          ü§ç
        {% endif %}
        <span class="ms-1">{{ post.like_count }}</span>
      </button>
    </form>

    {% if user.is_authenticated and user != post.author %}
      <form action="{% url 'board:user_follow_toggle' post.author.pk %}" method="post" style="display:inline;">
        {% csrf_token %}
        {% with post.author as author %}
          {% if is_following %}
            <button type="submit" class="btn btn-outline-danger btn-sm">–û—Ç–ø–∏—Å–∞—Ç—å—Å—è</button>
          {% else %}
            <button type="submit" class="btn btn-outline-primary btn-sm">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
          {% endif %}
        {% endwith %}
      </form>
    {% endif %}
  </div>

  <hr>

  <h2 class="mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h2>

  {% if comments %}
    {% for comment in comments %}
      <div class="card mb-3">
        <div class="card-body d-flex">
          {% if comment.author.avatar %}
            <img src="{{ comment.author.avatar.url }}" alt="–ê–≤–∞—Ç–∞—Ä" class="rounded-circle me-3" width="50" height="50">
          {% else %}
            <div class="bg-secondary rounded-circle me-3" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
              {{ comment.author.username|first|upper }}
            </div>
          {% endif %}
          <div>
            <strong>{{ comment.author.username }}</strong>
            <div class="text-muted small">{{ comment.created_at|date:"d.m.Y H:i" }}</div>
            <p class="mt-2 mb-0">{{ comment.content|linebreaks }}</p>
          </div>
        </div>
      </div>
    {% endfor %}

    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º" class="mt-4">
      <ul class="pagination justify-content-center">
        {% if comments.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ comments.previous_page_number }}">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ comments.number }} –∏–∑ {{ comments.paginator.num_pages }}</span>
        </li>

        {% if comments.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ comments.next_page_number }}">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</span></li>
        {% endif %}
      </ul>
    </nav>

  {% else %}
    <p>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
  {% endif %}

  <hr>

  {% if user.is_authenticated %}
    <h2 class="mb-3">–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            <div>{{ error }}</div>
          {% endfor %}
        </div>
      {% endif %}

      {% for field in form %}
        <div class="mb-3">
          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
          {{ field }}
          {% if field.help_text %}
            <div class="form-text">{{ field.help_text }}</div>
          {% endif %}
          {% for error in field.errors %}
            <div class="text-danger small">{{ error }}</div>
          {% endfor %}
        </div>
      {% endfor %}

      <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  {% else %}
    <div class="alert alert-info">
      –ß—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, <a href="{% url 'board:login' %}?next={{ request.path }}">–≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</a>.
    </div>
  {% endif %}
</div>
{% endblock %}
